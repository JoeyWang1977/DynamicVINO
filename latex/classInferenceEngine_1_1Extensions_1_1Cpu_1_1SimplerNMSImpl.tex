\hypertarget{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl}{}\section{Inference\+Engine\+:\+:Extensions\+:\+:Cpu\+:\+:Simpler\+N\+M\+S\+Impl Class Reference}
\label{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl}\index{Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl@{Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl}}


Inheritance diagram for Inference\+Engine\+:\+:Extensions\+:\+:Cpu\+:\+:Simpler\+N\+M\+S\+Impl\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=222pt]{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for Inference\+Engine\+:\+:Extensions\+:\+:Cpu\+:\+:Simpler\+N\+M\+S\+Impl\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=234pt]{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl_a55c75336ef850f3554eb11d979544252}{Simpler\+N\+M\+S\+Impl} (const C\+N\+N\+Layer $\ast$layer)
\item 
Status\+Code \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl_abb6b12445f7c6b55c44564bb28f3b7c5}{execute} (std\+::vector$<$ Blob\+::\+Ptr $>$ \&inputs, std\+::vector$<$ Blob\+::\+Ptr $>$ \&outputs, Response\+Desc $\ast$resp) noexceptoverride
\end{DoxyCompactItemize}
\subsection*{Additional Inherited Members}


\subsection{Detailed Description}


Definition at line 210 of file ext\+\_\+simplernms.\+cpp.



\subsection{Constructor \& Destructor Documentation}
\index{Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl@{Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl}!Simpler\+N\+M\+S\+Impl@{Simpler\+N\+M\+S\+Impl}}
\index{Simpler\+N\+M\+S\+Impl@{Simpler\+N\+M\+S\+Impl}!Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl@{Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl}}
\subsubsection[{\texorpdfstring{Simpler\+N\+M\+S\+Impl(const C\+N\+N\+Layer $\ast$layer)}{SimplerNMSImpl(const CNNLayer *layer)}}]{\setlength{\rightskip}{0pt plus 5cm}Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl\+::\+Simpler\+N\+M\+S\+Impl (
\begin{DoxyParamCaption}
\item[{const C\+N\+N\+Layer $\ast$}]{layer}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [explicit]}}\hypertarget{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl_a55c75336ef850f3554eb11d979544252}{}\label{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl_a55c75336ef850f3554eb11d979544252}


Definition at line 212 of file ext\+\_\+simplernms.\+cpp.


\begin{DoxyCode}
212                                                   : \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_affff0e8263ca26852ccf71d299d7b06a}{ExtLayerBase}(layer) \{
213         \textcolor{keywordflow}{try} \{
214             \textcolor{keywordflow}{if} (\hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.insData.size() != 3 || \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.outData.size() != 1)
215                 THROW\_IE\_EXCEPTION << \textcolor{stringliteral}{"Incorrect number of input/output edges!"};
216 
217             min\_box\_size\_ = \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.GetParamAsInt(\textcolor{stringliteral}{"min\_bbox\_size"});
218             feat\_stride\_ = \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.GetParamAsInt(\textcolor{stringliteral}{"feat\_stride"});
219             pre\_nms\_topn\_ = \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.GetParamAsInt(\textcolor{stringliteral}{"pre\_nms\_topn"});
220             post\_nms\_topn\_ = \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.GetParamAsInt(\textcolor{stringliteral}{"post\_nms\_topn"});
221             iou\_threshold\_ = \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.GetParamAsFloat(\textcolor{stringliteral}{"iou\_threshold"});
222             scales = \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.GetParamAsFloats(\textcolor{stringliteral}{"scale"}, \{\});
223 
224             \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} default\_size = 16;
225 
226             ratios = \{0.5f, 1.0f, 2.0f\};
227 
228             anchors\_.resize(ratios.size() * scales.size());
229             simpler\_nms\_anchor *anchors = &anchors\_[0];
230 
231             \hyperlink{namespaceInferenceEngine_1_1Extensions_1_1Cpu_a372135d51e4474280774a7ca10933c84}{GenerateAnchors}(default\_size, ratios, scales, anchors);
232 
233             \textcolor{comment}{// Fill config information}
234             \textcolor{keywordflow}{if} (\hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.outData[0]->getTensorDesc().getDims().size() != 2 ||
235                     \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1074cdccacb9e9ca6eec01bbc2f7ca4a}{cnnLayer}.insData[0].lock()->getTensorDesc().getDims().size() != 4)
236                 THROW\_IE\_EXCEPTION << \textcolor{stringliteral}{"Unsupported dimensions!"};
237 
238             \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a0ac7a6632e95b9500d5246b05b4b0bfa}{addConfig}(\{DataConfigurator(\hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1258a8d209e0249e0b1717618352ddfba446687ea2db1ada75be5ed053be77f59}{ConfLayout::PLN}), DataConfigurator(
      \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1258a8d209e0249e0b1717618352ddfba446687ea2db1ada75be5ed053be77f59}{ConfLayout::PLN}), DataConfigurator(\hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1258a8d209e0249e0b1717618352ddfba446687ea2db1ada75be5ed053be77f59}{ConfLayout::PLN})\},
239                       \{DataConfigurator(\hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_a1258a8d209e0249e0b1717618352ddfba446687ea2db1ada75be5ed053be77f59}{ConfLayout::PLN})\});
240         \} \textcolor{keywordflow}{catch} (InferenceEngine::details::InferenceEngineException &ex) \{
241             \hyperlink{classInferenceEngine_1_1Extensions_1_1Cpu_1_1ExtLayerBase_abc78e9b5a79fa339ffd831a5318f71f7}{errorMsg} = ex.what();
242         \}
243     \}
\end{DoxyCode}


\subsection{Member Function Documentation}
\index{Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl@{Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl}!execute@{execute}}
\index{execute@{execute}!Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl@{Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl}}
\subsubsection[{\texorpdfstring{execute(std\+::vector$<$ Blob\+::\+Ptr $>$ \&inputs, std\+::vector$<$ Blob\+::\+Ptr $>$ \&outputs, Response\+Desc $\ast$resp) noexceptoverride}{execute(std::vector< Blob::Ptr > &inputs, std::vector< Blob::Ptr > &outputs, ResponseDesc *resp) noexceptoverride}}]{\setlength{\rightskip}{0pt plus 5cm}Status\+Code Inference\+Engine\+::\+Extensions\+::\+Cpu\+::\+Simpler\+N\+M\+S\+Impl\+::execute (
\begin{DoxyParamCaption}
\item[{std\+::vector$<$ Blob\+::\+Ptr $>$ \&}]{inputs, }
\item[{std\+::vector$<$ Blob\+::\+Ptr $>$ \&}]{outputs, }
\item[{Response\+Desc $\ast$}]{resp}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [override]}, {\ttfamily [noexcept]}}\hypertarget{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl_abb6b12445f7c6b55c44564bb28f3b7c5}{}\label{classInferenceEngine_1_1Extensions_1_1Cpu_1_1SimplerNMSImpl_abb6b12445f7c6b55c44564bb28f3b7c5}


Definition at line 245 of file ext\+\_\+simplernms.\+cpp.


\begin{DoxyCode}
246                                                              \{
247         \textcolor{keywordtype}{int} cls\_idx = 0;
248         \textcolor{keywordtype}{int} delta\_idx = 1;
249 
250         Blob::Ptr src\_cls = inputs[cls\_idx];
251         Blob::Ptr src\_delta = inputs[delta\_idx];
252 
253         \textcolor{keywordflow}{if} (src\_cls->getTensorDesc().getDims()[1] > src\_delta->getTensorDesc().getDims()[1]) \{
254             cls\_idx = 1;
255             delta\_idx = 0;
256 
257             src\_cls = inputs[cls\_idx];
258             src\_delta = inputs[delta\_idx];
259         \}
260 
261         \textcolor{keywordtype}{int} anchors\_num = 3 * 3;
262         \textcolor{keyword}{const} \textcolor{keyword}{auto} * anchors = (\textcolor{keyword}{const} simpler\_nms\_anchor*)&anchors\_[0];
263 
264         \textcolor{keywordtype}{int} H = src\_cls->getTensorDesc().getDims()[2];
265         \textcolor{keywordtype}{int} W = src\_cls->getTensorDesc().getDims()[3];
266 
267         \textcolor{keywordtype}{int} SZ = H * W;
268 
269         \textcolor{keywordtype}{float} *dst = outputs[0]->buffer().as<\textcolor{keywordtype}{float}*>();
270 
271         \textcolor{keyword}{const} \textcolor{keywordtype}{float}* cls\_scores = src\_cls->buffer().as<\textcolor{keyword}{const} \textcolor{keywordtype}{float}*>();
272         \textcolor{keyword}{const} \textcolor{keywordtype}{float}* delta\_pred = src\_delta->buffer().as<\textcolor{keyword}{const} \textcolor{keywordtype}{float}*>();
273         \textcolor{keyword}{const} \textcolor{keywordtype}{float}* im\_info = inputs[2]->buffer().as<\textcolor{keyword}{const} \textcolor{keywordtype}{float}*>();
274 
275         \textcolor{keywordtype}{int} IW = im\_info[1];
276         \textcolor{keywordtype}{int} IH = im\_info[0];
277         \textcolor{keywordtype}{int} IS = im\_info[2];
278 
279         \textcolor{keywordtype}{int} scaled\_min\_bbox\_size = min\_box\_size\_ * IS;
280 
281         std::vector<simpler\_nms\_proposal\_t> sorted\_proposals\_confidence;
282 
283         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} y = 0; y < H; ++y) \{
284             \textcolor{keywordtype}{int} anchor\_shift\_y = y * feat\_stride\_;
285 
286             \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} x = 0; x < W; ++x) \{
287                 \textcolor{keywordtype}{int} anchor\_shift\_x = x * feat\_stride\_;
288                 \textcolor{keywordtype}{int} location\_index = y * W + x;
289 
290                 \textcolor{comment}{// we assume proposals are grouped by window location}
291                 \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} anchor\_index = 0; anchor\_index < anchors\_num ; anchor\_index++) \{
292                     \textcolor{keywordtype}{float} dx0 = delta\_pred[location\_index + SZ * (anchor\_index * 4 + 0)];
293                     \textcolor{keywordtype}{float} dy0 = delta\_pred[location\_index + SZ * (anchor\_index * 4 + 1)];
294                     \textcolor{keywordtype}{float} dx1 = delta\_pred[location\_index + SZ * (anchor\_index * 4 + 2)];
295                     \textcolor{keywordtype}{float} dy1 = delta\_pred[location\_index + SZ * (anchor\_index * 4 + 3)];
296 
297                     simpler\_nms\_delta\_t bbox\_delta \{ dx0, dy0, dx1, dy1 \};
298 
299                     \textcolor{keywordtype}{float} proposal\_confidence =
300                             cls\_scores[location\_index + SZ * (anchor\_index + anchors\_num * 1)];
301 
302                     simpler\_nms\_roi\_t tmp\_roi = \hyperlink{namespaceInferenceEngine_1_1Extensions_1_1Cpu_aa02aa9d3ca8d6c473e44d1cd7d4f11dd}{simpler\_nms\_gen\_bbox}(anchors[
      anchor\_index], bbox\_delta, anchor\_shift\_x, anchor\_shift\_y);
303                     simpler\_nms\_roi\_t roi = tmp\_roi.clamp(\{ 0, 0, \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{float}\textcolor{keyword}{>}(IW - 1), 
      static\_cast<float>(IH - 1)\});
304 
305                     \textcolor{keywordtype}{int} bbox\_w = roi.x1 - roi.x0 + 1;
306                     \textcolor{keywordtype}{int} bbox\_h = roi.y1 - roi.y0 + 1;
307 
308                     \textcolor{keywordflow}{if} (bbox\_w >= scaled\_min\_bbox\_size && bbox\_h >= scaled\_min\_bbox\_size) \{
309                         simpler\_nms\_proposal\_t proposal \{ roi, proposal\_confidence, 
      sorted\_proposals\_confidence.size() \};
310                         sorted\_proposals\_confidence.push\_back(proposal);
311                     \}
312                 \}
313             \}
314         \}
315 
316         \hyperlink{namespaceInferenceEngine_1_1Extensions_1_1Cpu_a9ab5785b0943b51af3a2668ae9df0e11}{sort\_and\_keep\_at\_most\_top\_n}(sorted\_proposals\_confidence, pre\_nms\_topn\_);
317         \textcolor{keyword}{auto} res = \hyperlink{namespaceInferenceEngine_1_1Extensions_1_1Cpu_a6cef0ac4faf74f33e53449ba39304914}{simpler\_nms\_perform\_nms}(sorted\_proposals\_confidence, 
      iou\_threshold\_, post\_nms\_topn\_);
318 
319         \textcolor{keywordtype}{size\_t} res\_num\_rois = res.size();
320 
321         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < res\_num\_rois; ++i) \{
322             dst[5 * i + 0] = 0;    \textcolor{comment}{// roi\_batch\_ind, always zero on test time}
323             dst[5 * i + 1] = res[i].x0;
324             dst[5 * i + 2] = res[i].y0;
325             dst[5 * i + 3] = res[i].x1;
326             dst[5 * i + 4] = res[i].y1;
327         \}
328         \textcolor{keywordflow}{return} OK;
329     \}
\end{DoxyCode}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
thirdparty/extension/\hyperlink{ext__simplernms_8cpp}{ext\+\_\+simplernms.\+cpp}\end{DoxyCompactItemize}
